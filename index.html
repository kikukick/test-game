<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>novel_demo - fixed</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="style.css">

<!-- TyranoScript (attempt via CDN) 
     NOTE: Tyrano CDN availability varies. We attempt to load it but do NOT rely on it.
-->
<script src="https://cdn.jsdelivr.net/gh/ShikemokuMK/tyranoscript/tyrano/tyrano.core.js"></script>
<script src="https://cdn.jsdelivr.net/gh/ShikemokuMK/tyranoscript/tyrano/lang/ja.js"></script>
<script src="https://cdn.jsdelivr.net/gh/ShikemokuMK/tyranoscript/tyrano/tyrano.plugin.kag.js"></script>

<!-- External libraries (CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.8/browser/pixi.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/typed.js/2.1.0/typed.min.js"></script>

<!-- custom effects (robust) -->
<script src="data/others/plugin/custom_effects.js"></script>

</head>
<body>
  <div id="tyrano_base"></div>

  <script>
  /**
   * 起動ロジック：
   *  - Tyrano が利用可能で正常に初期化できれば Tyrano を使う
   *  - それ以外はフォールバックの簡易デモ（DOM ベース）を実行
   */
  (function(){
    function startTyranoIfPossible(){
      try {
        // tyrano.plugin.kag が存在し、init 関数があるならそれを使う
        if (window.tyrano && tyrano.plugin && tyrano.plugin.kag && typeof tyrano.plugin.kag.init === 'function') {
          console.log("Tyrano detected — initializing tyrano.plugin.kag.init()");
          // Tyrano の初期化（エンジンによっては init の呼び方が異なる場合があるため try/catch）
          try {
            tyrano.plugin.kag.init();
            return true;
          } catch(e){
            console.warn("tyrano.plugin.kag.init() failed:", e);
            return false;
          }
        }
      } catch(e){
        console.warn("tyrano check error:", e);
        return false;
      }
      return false;
    }

    function startFallbackDemo(){
      console.log("Starting fallback demo (no/old Tyrano).");
      // 簡易ノベルDOMを生成して、custom_effects の関数を呼び出す
      const base = document.getElementById('tyrano_base');

      // クリア
      base.innerHTML = '';

      // 背景
      const bg = document.createElement('div');
      bg.id = 'fallback_bg';
      bg.style.position = 'fixed';
      bg.style.left = 0;
      bg.style.top = 0;
      bg.style.width = '100%';
      bg.style.height = '100%';
      bg.style.backgroundSize = 'cover';
      bg.style.backgroundPosition = 'center';
      bg.style.zIndex = 1;
      bg.style.backgroundImage = 'url("data/image/bg_stage1.jpg")';
      base.appendChild(bg);

      // キャラレイヤー
      const charLayer = document.createElement('div');
      charLayer.id = 'fallback_chars';
      charLayer.style.position = 'fixed';
      charLayer.style.left = 0;
      charLayer.style.top = 0;
      charLayer.style.width = '100%';
      charLayer.style.height = '100%';
      charLayer.style.zIndex = 2;
      base.appendChild(charLayer);

      const hero = document.createElement('img');
      hero.src = 'data/image/char_hero.png';
      hero.style.position = 'absolute';
      hero.style.left = '8%';
      hero.style.bottom = '12%';
      hero.style.width = '28%';
      hero.style.maxWidth = '380px';
      charLayer.appendChild(hero);

      const friend = document.createElement('img');
      friend.src = 'data/image/char_friend.png';
      friend.style.position = 'absolute';
      friend.style.right = '8%';
      friend.style.bottom = '12%';
      friend.style.width = '28%';
      friend.style.maxWidth = '380px';
      charLayer.appendChild(friend);

      // メッセージウィンドウ
      const msg = document.createElement('div');
      msg.id = 'fallback_msg';
      msg.className = 'message_window';
      msg.style.zIndex = 3;
      base.appendChild(msg);

      const nameLabel = document.createElement('div');
      nameLabel.className = 'name_label';
      nameLabel.textContent = '—';
      msg.appendChild(nameLabel);

      const textArea = document.createElement('div');
      textArea.id = 'fallback_text';
      textArea.style.marginTop = '8px';
      msg.appendChild(textArea);

      const choiceBox = document.createElement('div');
      choiceBox.id = 'fallback_choices';
      choiceBox.className = 'choice_box';
      msg.appendChild(choiceBox);

      // typed.js wrapper
      function showLine(speaker, text, opts = {}) {
        nameLabel.textContent = speaker || '';
        textArea.innerHTML = '';
        choiceBox.innerHTML = '';
        if (window.NovelEffects && typeof NovelEffects.typeLine === 'function') {
          // NovelEffects.typeLine expects a DOM area; but our NovelEffects.typeLine will try to find Tyrano elements.
          // Instead use Typed directly here for reliability.
          if (typeof Typed !== 'undefined') {
            const typedTarget = document.createElement('span');
            textArea.appendChild(typedTarget);
            new Typed(typedTarget, {
              strings: [text],
              typeSpeed: opts.speed ? Math.max(10, Math.round(1000/opts.speed)) : 25,
              showCursor: opts.cursor !== false,
              onComplete: function(){ /* noop */ }
            });
          } else {
            // fallback simple
            textArea.textContent = text;
          }
        } else {
          textArea.textContent = text;
        }
      }

      // simple BGM using Howler if available
      let fallbackBGM = null;
      function playBGM(src){
        if (typeof Howl !== 'undefined') {
          if (fallbackBGM) {
            try { fallbackBGM.fade(fallbackBGM.volume()||1, 0, 600); setTimeout(()=>fallbackBGM.stop(), 700); } catch(e){}
          }
          fallbackBGM = new Howl({ src: [src], loop: true, volume: 0 });
          fallbackBGM.play();
          fallbackBGM.fade(0,1,600);
        } else {
          // do nothing
        }
      }

      // small scenario flow (mirrors first.ks)
      playBGM('data/bgm/theme1.ogg');
      showLine('主人公', '今日はなんだか雰囲気が違うな……', {speed:45});
      setTimeout(()=> {
        showLine('友人', '本当に？ どこが？', {speed:40});
      }, 2200);

      // show choices after a bit
      setTimeout(()=> {
        choiceBox.innerHTML = '';
        const c1 = document.createElement('button');
        c1.textContent = '穏やかに話す';
        c1.onclick = () => {
          // call soft particle
          if (window.createSoftParticle) createSoftParticle();
          showLine('主人公', 'いや、ただの気のせいかも。', {speed:45});
          setTimeout(()=> proceedAfterEffect('soft'), 1400);
        };
        const c2 = document.createElement('button');
        c2.textContent = '少し怒鳴る';
        c2.onclick = () => {
          if (window.createAngryRipple) createAngryRipple();
          showLine('主人公', 'なんで分からないんだよ！！', {speed:40});
          setTimeout(()=> proceedAfterEffect('angry'), 1400);
        };
        choiceBox.appendChild(c1);
        choiceBox.appendChild(c2);
      }, 4200);

      function proceedAfterEffect(kind){
        // blackout -> switch background -> change BGM -> unblackout
        if (window.blackout && window.switchStage && window.unblackout && window.fadeToBGM) {
          blackout(0.6, function(){
            switchStage('data/image/bg_stage2.jpg');
            fadeToBGM('data/bgm/theme2.ogg', 1.0);
            unblackout(0.6);
          });
        } else {
          // fallback: instant switch
          bg.style.backgroundImage = 'url("data/image/bg_stage2.jpg")';
        }

        // now continue conversation with a choice
        setTimeout(()=> {
          showLine('友人', '……ここでは話しにくいから移動しよう。', {speed:45});
          // next choices
          setTimeout(()=> {
            choiceBox.innerHTML = '';
            const a = document.createElement('button');
            a.textContent = '誤解を解く';
            a.onclick = () => {
              if (window.createConfetti) createConfetti();
              showLine('主人公', 'ごめん、誤解だった。', {speed:45});
              setTimeout(()=> endingGood(), 1200);
            };
            const b = document.createElement('button');
            b.textContent = 'そのまま去る';
            b.onclick = () => {
              if (window.createDust) createDust();
              showLine('主人公', '……もういい。', {speed:45});
              setTimeout(()=> endingBad(), 1200);
            };
            choiceBox.appendChild(a);
            choiceBox.appendChild(b);
          }, 1000);
        }, 900);
      }

      function endingGood(){
        if (window.blackout && window.createParticleBurst) {
          blackout(0.6, function(){ createParticleBurst(); });
        }
        showLine('友人', 'またゆっくり話そう。', {speed:45});
        // end: stop BGM
        if (fallbackBGM) try { fallbackBGM.fade(1, 0, 1200); setTimeout(()=>fallbackBGM.stop(), 1300); } catch(e){}
      }

      function endingBad(){
        if (window.blackout && window.createLonelyFade) {
          blackout(0.9, function(){ createLonelyFade(); });
        }
        showLine('友人', '……気をつけてね。', {speed:45});
        if (fallbackBGM) try { fallbackBGM.fade(1, 0, 1200); setTimeout(()=>fallbackBGM.stop(), 1300); } catch(e){}
      }
    }

    // On load: try Tyrano, otherwise fallback
    window.addEventListener('load', function(){
      // small timeout so scripts loaded
      setTimeout(function(){
        const ok = startTyranoIfPossible();
        if (!ok) {
          // If tyrano exists but old tyrano.js triggers AC_FL_RunContent error earlier,
          // that can have aborted execution. We still try fallback.
          startFallbackDemo();
        }
      }, 200);
    });

  })();
  </script>
</body>
</html>
